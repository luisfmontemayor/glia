[tasks."gliar:bundle"]
description = "Sync minimal Rust core files to gliar/src/rust"
dir = "gliar"
sources = [
    "../glia_core/Cargo.toml",
    "../glia_core/Cargo.lock",
    "../glia_core/src/**/*.rs",
]
run = """
mkdir -p src/rust/src

cp ../glia_core/Cargo.toml src/rust/
cp ../glia_core/Cargo.lock src/rust/

# We strictly copy .rs files. This excludes python cache, venvs, and build artifacts.
rsync -a --delete ../glia_core/src/ src/rust/src/

if ! grep -q '"staticlib"' src/rust/Cargo.toml; then
    echo "Patching Cargo.toml for static linking..."
    sed -i 's/crate-type = \\[.*\\]/crate-type = ["staticlib", "cdylib", "rlib"]/' src/rust/Cargo.toml
fi
"""

[tasks."gliar:build"]
description = "Bundle, Document, and Install the gliar package"
dir         = "gliar"
depends     = ["gliar:bundle"]
run         = "Rscript -e 'rextendr::document(); devtools::install()'"
