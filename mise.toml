[settings]
experimental = true
lockfile     = true

[tools]
gum    = "0.17.0"
python = "3.12.0" # Also listed in pyproject.toml
r      = "4.4.1"
ruff   = "0.14.8"
uv     = "0.9.17"

[env]
_.file        = ".env"
_.path        = ["./scripts"]
PYTHONPATH    = "{{config_root}}/scripts:$PYTHONPATH"
GLIA_DEV_MODE = true

# Tools
[tasks.alembic]
description = "Internal helper for alembic commands"
run         = "uv run alembic -c backend/alembic.ini"

# Dependencies
[tasks.setup-mise-deps]
description = "Program deps"
run         = "mise install"

[tasks.setup-python-deps]
description = "Python deps"
alias       = "spd"
run         = "uv sync && uv lock"

[tasks.sync-lazygit]
description = "Program deps"
run         = "cp --force lazygit.yml .git/lazygit.yml"

# Database
[tasks."db:setup-creds"]
description = "Setup credentials and container"
run         = "setup_postgres_creds.py"
raw         = true

[tasks."db:up"]
description = "Start Postgres container"
run         = "docker compose -f backend/compose.yml up -d"

[tasks."db:down"]
description = "Stop Postgres container"
run         = "docker compose -f backend/compose.yml down"

[tasks."db:logs"]
description = "View Postgres logs"
run         = "docker compose -f backend/compose.yml logs -f"

[tasks."db:reset"]
description = "Wipe and restart DB (deletes all data)"
run         = "docker compose -f backend/compose.yml down -v && mise run db:up"

[tasks."db:status"]
description = "Verify DB is up, healthy, and credentials are valid"
run         = 'docker compose -f backend/compose.yml exec -T postgres psql -U "$POSTGRES_USER" -d "$POSTGRES_DB" -q -c "SELECT 1"'

[tasks."db:status-wait"]
description = "Poll the database until it accepts connections"
run = """
MAX_TRIES=15
COUNT=0

# Loop quietly
until mise run db:status > /dev/null 2>&1; do
  COUNT=$((COUNT + 1))
  if [ $COUNT -ge $MAX_TRIES ]; then
    echo "\n[ERROR] Database failed to become ready after $MAX_TRIES seconds."
    echo "Last error from psql:"
    # Run one last time WITHOUT hiding output so you see the error
    mise run db:status
    exit 1
  fi
  printf "."
  sleep 1
done
echo "\n[SUCCESS] Database is ready."
"""

[tasks."db:migration-plan"]
description = "Generate a new migration script"
run         = "mise run alembic revision --autogenerate -m"

[tasks."db:migrate"]
description = "Apply pending migrations to the database"
run         = "mise run alembic upgrade head"

[tasks."db:migration-rollback"]
description = "Rollback the last migration"
run         = "mise run alembic downgrade -1"

# API
[tasks."api:up"]
run = "uv run fastapi dev backend/main.py"

[tasks."api:status"]
run = "curl -s http://localhost:8000/health"

# Backend
[tasks."test:backend"]
run = "uv run pytest backend/test"

# Setup
[tasks."setup:deps"]
alias = "sd"
description = "Run all setup tasks in order"
run = """
mise run setup-mise-deps && \
mise run setup-python-deps && \
mise run sync-lazygit
"""
[tasks."setup:db"]
description = "Full database lifecycle: creds -> container -> wait -> migrations"
run = """
mise run db:setup-creds && \
mise run db:up && \
mise run db:status-wait && \
mise run db:migrate
"""

[tasks."setup:api"]
description = "Start API, then run status check and tests in parallel"
run = [
  { task = "api:up" },
  # These run in parallel the api:up task runs
  { tasks = ["api:status", "test:backend"] },
]

[tasks."setup:backend"]
description = "Full database lifecycle: creds -> container -> wait -> migrations"
run = """
mise run setup:db && \
mise run setup:api
"""

[tasks.full-setup]
description = "Plug-and-play setup: dependencies then local database"
run = """
mise run setup:deps && \
mise run setup:db && \
mise run setup:backend
"""

[tasks.spinup]
description = "Plug-and-play setup: dependencies then local database"
run = """
mise run db:up && \
mise run setup:backend
"""
