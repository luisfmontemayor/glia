[settings]
experimental = true
lockfile     = true

[tools]
gum    = "0.17.0"
python = "3.12.0" # Also listed in pyproject.toml
r      = "4.4.1"
ruff   = "0.14.8"
uv     = "0.9.17"

[env]
_.file     = ".env"
_.path     = ["./scripts"]
PYTHONPATH = "{{config_root}}/scripts:$PYTHONPATH"

VERSION = "0.1.0"

GLIA_DEV_MODE = true

# Tools
[tasks.alembic]
description = "Internal helper for alembic commands"
run         = "uv run alembic -c backend/alembic.ini"

# Nomenclature
# - db -> the database
# - api -> fastapi + uvicorn server
# - backend -> db+api+server

# Simple tasks:
# - up -> start service
# - down -> turn off service
# - status -> checking if service is up
# - test-wait -> test ran a few times to see if it succeeds (accounting for connection issues).
# and other specific ones like migrate

# Compound tasks:
# - setup -> from scratch: create configs and start service
# - spinup -> start service, not from scratch. often up + test

# task name structure:
# - mise run <service>:<task> eg.: mise run db:up
# or, for a service/tier-wide task:
# - mise run <compound task>:<tier> eg.: mise run spinup:db

# Dependencies
[tasks.setup-mise-deps]
description = "Program deps"
run         = "mise install"

[tasks.setup-python-deps]
description = "Python deps"
alias       = "spd"
run         = "uv sync && uv lock"

[tasks.sync-lazygit]
description = "Program deps"
run         = "cp --force lazygit.yml .git/lazygit.yml"

# Database
[tasks."db:setup-creds"]
description = "Setup credentials and container"
run         = "setup_postgres_creds.py"
raw         = true

[tasks."db:up"]
description = "Start Postgres container"
run         = "docker compose -f backend/compose.yml up -d"

[tasks."db:down"]
description = "Stop Postgres container"
run         = "docker compose -f backend/compose.yml down"

[tasks."db:logs"]
description = "View Postgres logs"
run         = "docker compose -f backend/compose.yml logs -f"

[tasks."db:reset"]
description = "Wipe and restart DB (deletes all data)"
run         = "docker compose -f backend/compose.yml down -v && mise run db:up"

[tasks."db:status"]
description = "Verify DB is up, healthy, and credentials are valid"
run         = 'docker compose -f backend/compose.yml exec -T postgres psql -U "$POSTGRES_USER" -d "$POSTGRES_DB" -q -c "SELECT 1"'

[tasks."db:status-wait"]
description = "Poll the database until it accepts connections"
run = """
MAX_TRIES=15
COUNT=0

# Loop quietly
until mise run db:status > /dev/null 2>&1; do
  COUNT=$((COUNT + 1))
  if [ $COUNT -ge $MAX_TRIES ]; then
    echo "\n[ERROR] Database failed to become ready after $MAX_TRIES seconds."
    echo "Last error from psql:"
    # Run one last time WITHOUT hiding output so you see the error
    mise run db:status
    exit 1
  fi
  printf "."
  sleep 1
done
echo "\n[SUCCESS] Database is ready."
"""

[tasks."db:migration-plan"]
description = "Generate a new migration script"
run         = "mise run alembic revision --autogenerate -m"

[tasks."db:migrate"]
description = "Apply pending migrations to the database"
run         = "mise run alembic upgrade head"

[tasks."db:migration-rollback"]
description = "Rollback the last migration"
run         = "mise run alembic downgrade -1"

# API
[tasks."api:up"]
run = "uv run fastapi dev backend/main.py"

[tasks."api:status"]
run = "curl -sf -o /dev/null http://localhost:8000/health"

[tasks."api:status-wait"]
description = "Poll the database until it accepts connections"
run = """
MAX_TRIES=15
COUNT=0

# Loop quietly
until mise run db:status > /dev/null 2>&1; do
  COUNT=$((COUNT + 1))
  if [ $COUNT -ge $MAX_TRIES ]; then
    echo "\n[ERROR] Database failed to become ready after $MAX_TRIES seconds."
    echo "Last error from psql:"
    # Run one last time WITHOUT hiding output so you see the error
    mise run api:status
    exit 1
  fi
  printf "."
  sleep 1
done
echo "\n[SUCCESS] Database is ready."
"""

# Backend
[tasks."test:backend"]
run = "uv run pytest backend/test --color=yes"

# Spinup
[tasks."spinup:db"]
description = "Start db container, no cred setup"
run = """
mise run db:up && \
mise run db:status-wait && \
mise run db:migrate
"""

[tasks."spinup:backend"]
description = "turn on backend, with tests"
alias = "sb"
run = """
mise run spinup:db && \
mise run api:up
"""

# Setup
[tasks."setup:deps"]
alias = "sd"
description = "Run all deps installation tasks"
run = """
mise run setup-mise-deps && \
mise run setup-python-deps && \
mise run sync-lazygit
"""
[tasks."setup:db"]
description = "Full database lifecycle: creds -> container -> wait -> migrations"
run = """
mise run db:setup-creds && \
mise run db:up && \
mise run db:status-wait && \
mise run db:migrate
"""

[tasks."setup:backend"]
description = "Full database lifecycle: creds -> container -> wait -> migrations"
run = """
mise run setup:db && \
mise run spinup:api
"""

[tasks.full-setup]
description = "Plug-and-play setup from scratch: dependencies then local database"
run = """
mise run setup:deps && \
mise run setup:db && \
mise run setup:backend
"""
