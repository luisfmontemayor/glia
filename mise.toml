[settings]
experimental = true
lockfile     = true

[tools]
gum    = "0.17.0"
python = "3.12.0" # Also listed in pyproject.toml
r      = "4.4.1"
ruff   = "0.14.8"
uv     = "0.9.17"

[env]
_.path     = ["./scripts"]
PYTHONPATH = "{{config_root}}/scripts:$PYTHONPATH"

# Dependencies
[tasks.setup-mise-deps]
description = "Program deps"
run         = "mise install"

[tasks.setup-python-deps]
description = "Python deps"
alias       = "spd"
run         = "uv sync && uv lock"

[tasks.sync-lazygit]
description = "Program deps"
run         = "cp --force lazygit.yml .git/lazygit.yml"

[tasks."setup:deps"]
description = "Run all setup tasks in order"
run = """
mise run setup-mise-deps && \
mise run setup-python-deps && \
mise run sync-lazygit
"""

# Database
[tasks."db:setup-creds"]
description = "Setup credentials and container"
run         = "setup_postgres_creds.py"
raw         = true

[tasks."db:up"]
description = "Start Postgres container"
run         = "docker compose -f backend/compose.yaml up -d"

[tasks."db:down"]
description = "Stop Postgres container"
run         = "docker compose -f backend/compose.yaml down"

[tasks."db:logs"]
description = "View Postgres logs"
run         = "docker compose -f backend/compose.yaml logs -f"

[tasks."db:reset"]
description = "Wipe and restart DB (deletes all data)"
run         = "docker compose -f backend/compose.yaml down -v && mise run db:up"

[tasks."test:db-init"]
description = "Verify DB is up, healthy, and credentials are valid"
run         = "docker compose exec -T postgres psql -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-postgres} -q -c 'SELECT 1'"

[tasks."db:alembic-init"]
run = "uv run alembic -c backend/alembic.ini"

[tasks."db:alembic-revision"]
description = "Generate a new migration script"
run         = "mise run alembic revision --autogenerate -m"

[tasks."db:alembic-migrate"]
description = "Apply pending migrations to the database"
run         = "mise run alembic upgrade head"

[tasks."db:alembic-rollback"]
description = "Rollback the last migration"
run         = "mise run alembic downgrade -1"

[tasks."db:wait"]
description = "Block until the database is accepting connections"
run = """
echo "Waiting for database..." >&2
# Try for 30 seconds
timeout 30s bash -c 'until mise run test:db-init > /dev/null 2>&1; do sleep 1; done'
echo "Database is ready!" >&2
"""

[tasks."setup:db"]
description = "Full database lifecycle: creds -> container -> wait -> migrations"
run = """
mise run db:setup-creds && \
mise run db:up && \
mise run db:wait && \
mise run db:migrate
"""

[tasks.full-setup]
description = "Plug-and-play setup: dependencies then local database"
run = """
mise run setup-deps && \
mise run setup-db-creds
"""

#[tasks."test:integration"]
#description = "Run integration tests (requires DB)"
#depends = ["db-check"] # Using the task we just made!
#run = "uv run pytest tests/integration"}
